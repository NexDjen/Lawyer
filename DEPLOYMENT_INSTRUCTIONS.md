# ðŸš€ Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð¿Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸ÑŽ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸

## âœ… Ð ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸

### 1. **ÐÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð°Ñ TTS Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ** âš¡
- **Ð­Ñ„Ñ„ÐµÐºÑ‚**: x3-5 ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²
- **Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¾**: `backend/controllers/chatController.js`
- **Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚**: ÐžÑ‚Ð²ÐµÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ÑÑ ÑÑ€Ð°Ð·Ñƒ, TTS Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð² Ñ„Ð¾Ð½Ðµ

### 2. **ÐŸÑƒÐ» HTTP ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¹** ðŸ”—
- **Ð­Ñ„Ñ„ÐµÐºÑ‚**: -10-20% latency
- **Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¾**: `backend/services/chatService.js`
- **Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚**: 
  - `keepAlive: true`
  - `maxSockets: 50`
  - `maxFreeSockets: 10`

### 3. **Rate Limiting** ðŸš¦
- **Ð­Ñ„Ñ„ÐµÐºÑ‚**: Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Ð¿ÐµÑ€ÐµÐ³Ñ€ÑƒÐ·ÐºÐ¸
- **Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾**: `backend/middleware/rateLimiter.js`
- **Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¾**: `backend/routes/chatRoutes.js`
- **Ð›Ð¸Ð¼Ð¸Ñ‚Ñ‹**:
  - Chat: 10 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²/Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ Ð½Ð° IP/userId
  - API: 100 Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²/Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ

### 4. **Ð“Ð¾Ñ€Ð¸Ð·Ð¾Ð½Ñ‚Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¼Ð°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ** ðŸ“ˆ
- **Ð­Ñ„Ñ„ÐµÐºÑ‚**: x3 ÑƒÐ²ÐµÐ»Ð¸Ñ‡ÐµÐ½Ð¸Ðµ RPS
- **Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¾**: `docker-compose.yml`
- **Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚**: 3 Ð¸Ð½ÑÑ‚Ð°Ð½ÑÐ° backend (Ð¿Ð¾Ñ€Ñ‚Ñ‹ 3007, 3008, 3009)

### 5. **Nginx Load Balancer** âš–ï¸
- **Ð­Ñ„Ñ„ÐµÐºÑ‚**: Ð‘Ð°Ð»Ð°Ð½ÑÐ¸Ñ€Ð¾Ð²ÐºÐ° Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¼ÐµÐ¶Ð´Ñƒ Ð¸Ð½ÑÑ‚Ð°Ð½ÑÐ°Ð¼Ð¸
- **ÐÐ»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼**: least_conn (Ð½Ð°Ð¸Ð¼ÐµÐ½ÑŒÑˆÐµÐµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¹)

---

## ðŸ“¦ Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ

### Ð¨Ð°Ð³ 1: ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€

```bash
# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÐµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
scp -P 1040 docker-compose.yml sve@37.110.51.35:~/ai-lawyer/
scp -P 1040 backend/controllers/chatController.js sve@37.110.51.35:~/ai-lawyer/backend/controllers/
scp -P 1040 backend/services/chatService.js sve@37.110.51.35:~/ai-lawyer/backend/services/
scp -P 1040 backend/middleware/rateLimiter.js sve@37.110.51.35:~/ai-lawyer/backend/middleware/
scp -P 1040 backend/routes/chatRoutes.js sve@37.110.51.35:~/ai-lawyer/backend/routes/
```

### Ð¨Ð°Ð³ 2: ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx Load Balancer

```bash
# ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ
ssh sve@37.110.51.35 -p 1040

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ upstream ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
sudo tee /etc/nginx/conf.d/backend_upstream.conf > /dev/null << 'EOF'
upstream backend_pool {
    least_conn;
    
    server 127.0.0.1:3007 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:3008 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:3009 max_fails=3 fail_timeout=30s;
    
    keepalive 32;
}
EOF

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð¿Ð¾Ñ€Ñ‚Ð° 1041
sudo sed -i 's|proxy_pass http://127.0.0.1:3007;|proxy_pass http://backend_pool;|g' /etc/nginx/sites-available/lawyer-1041.conf

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ nginx
sudo nginx -t && sudo systemctl reload nginx
```

### Ð¨Ð°Ð³ 3: ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²

```bash
cd ~/ai-lawyer

# ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
docker compose down

# ÐŸÐµÑ€ÐµÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ñ Ð½Ð¾Ð²Ñ‹Ð¼ ÐºÐ¾Ð´Ð¾Ð¼
docker compose build

# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ 3 Ð¸Ð½ÑÑ‚Ð°Ð½ÑÐ°
docker compose up -d

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
docker compose ps
```

### Ð¨Ð°Ð³ 4: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð¾ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚Ð¸

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð²ÑÐµ 3 Ð¸Ð½ÑÑ‚Ð°Ð½ÑÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚
curl http://localhost:3007/health
curl http://localhost:3008/health
curl http://localhost:3009/health

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ load balancer
curl http://localhost:1041/api/chat/status

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð´Ð¾Ð¼ÐµÐ½
curl https://lawyer.windexs.ru:1041/api/chat/status
```

---

## ðŸ“Š ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ðµ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹

| ÐœÐµÑ‚Ñ€Ð¸ÐºÐ° | Ð”Ð¾ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ | ÐŸÐ¾ÑÐ»Ðµ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ | Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ðµ |
|---------|----------------|-------------------|-----------|
| **RPS** | 0.45 | 1.5-2.0 | **x3-4** |
| **Ð’Ñ€ÐµÐ¼Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð°** | 8-25s | 3-5s | **x3-5** |
| **ÐžÐ´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹** | 5-10 | 20-50 | **x4-5** |

---

## ðŸ” ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³

### Ð›Ð¾Ð³Ð¸ Docker
```bash
# Ð›Ð¾Ð³Ð¸ Ð²ÑÐµÑ… Ð¸Ð½ÑÑ‚Ð°Ð½ÑÐ¾Ð²
docker compose logs -f

# Ð›Ð¾Ð³Ð¸ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ð¸Ð½ÑÑ‚Ð°Ð½ÑÐ°
docker compose logs -f backend-1
docker compose logs -f backend-2
docker compose logs -f backend-3
```

### Nginx ÑÑ‚Ð°Ñ‚ÑƒÑ
```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° upstream ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
sudo tail -f /var/log/nginx/access.log | grep "backend_pool"
```

### ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸
```bash
# Ð¢ÐµÐºÑƒÑ‰Ð¸Ðµ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ
ss -tnp | grep :3007
ss -tnp | grep :3008
ss -tnp | grep :3009

# ÐŸÑ€Ð¾Ñ†ÐµÑÑÐ¾Ñ€ Ð¸ Ð¿Ð°Ð¼ÑÑ‚ÑŒ
docker stats
```

---

## ðŸ› Ð ÐµÑˆÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°: ÐžÐ´Ð¸Ð½ Ð¸Ð· Ð¸Ð½ÑÑ‚Ð°Ð½ÑÐ¾Ð² Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ
```bash
# Ð¡Ð¼Ð¾Ñ‚Ñ€Ð¸Ð¼ Ð»Ð¾Ð³Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð¸Ð½ÑÑ‚Ð°Ð½ÑÐ°
docker compose logs backend-2

# ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ð¸Ð½ÑÑ‚Ð°Ð½Ñ
docker compose restart backend-2
```

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°: Load balancer Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚
```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
sudo nginx -t

# Ð¡Ð¼Ð¾Ñ‚Ñ€Ð¸Ð¼ Nginx Ð»Ð¾Ð³Ð¸
sudo tail -f /var/log/nginx/error.log

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ upstream
curl -I http://localhost:1041/api/chat/status
```

### ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°: Rate limiting ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ ÑÑ‚Ñ€Ð¾Ð³Ð¸Ð¹
```bash
# Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ Ð² backend/middleware/rateLimiter.js
# ÐœÐµÐ½ÑÐµÐ¼ max: 10 Ð½Ð° Ð½ÑƒÐ¶Ð½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
# ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ backend
docker compose restart backend-1 backend-2 backend-3
```

---

## ðŸ“ˆ Ð”Ð°Ð»ÑŒÐ½ÐµÐ¹ÑˆÐ¸Ðµ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ

### Ð•ÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ ÐµÑ‰Ðµ Ð±Ð¾Ð»ÑŒÑˆÐµ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸:

1. **Ð£Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¸Ð½ÑÑ‚Ð°Ð½ÑÐ¾Ð² Ð´Ð¾ 5-10**
   - Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ `docker-compose.yml`
   - ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Nginx upstream

2. **Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Redis Ð´Ð»Ñ ÑÐµÑÑÐ¸Ð¹**
   - Ð¥Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Redis
   - Ð£Ð±Ñ€Ð°Ñ‚ÑŒ state Ð¸Ð· Ð¿Ð°Ð¼ÑÑ‚Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ

3. **Streaming Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²**
   - Ð ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ñ‚ÑŒ Server-Sent Events
   - ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð±ÑƒÐ´ÐµÑ‚ Ð²Ð¸Ð´ÐµÑ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¿Ð¾ Ð¼ÐµÑ€Ðµ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸

4. **ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ (Prometheus + Grafana)**
   - ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
   - ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð°Ð»ÐµÑ€Ñ‚Ñ‹

---

*Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ ÑÐ¾Ð·Ð´Ð°Ð½: 2025-10-06*
*Ð’ÐµÑ€ÑÐ¸Ñ: 1.0*


