const WindexAI = require('openai'); // WindexAI API client
const config = require('../config/config');
const logger = require('../utils/logger');
const { readDb } = require('./documentStorage');
const { HttpsProxyAgent } = require('https-proxy-agent');
const PersonalDataExtractor = require('./personalDataExtractor');
const UserProfileService = require('./userProfileService');
const WindexAIStats = require('../models/WindexAIStats');
const webSearchService = require('./webSearchService');

class ChatService {
  constructor() {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
    const proxyUrl = process.env.HTTP_PROXY || process.env.HTTPS_PROXY;
    
    // –°–æ–∑–¥–∞–µ–º –ø—É–ª HTTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    const { Agent } = require('https');
    let agent;
    
    if (proxyUrl) {
      agent = new HttpsProxyAgent(proxyUrl, {
        keepAlive: true,
        keepAliveMsecs: 30000,
        maxSockets: 50,
        maxFreeSockets: 10,
        timeout: 30000
      });
    } else {
      agent = new Agent({
        keepAlive: true,
        keepAliveMsecs: 30000,
        maxSockets: 50,
        maxFreeSockets: 10,
        timeout: 30000
      });
    }
    
    logger.info('üîß ChatService initialization', {
      hasProxy: !!proxyUrl,
      proxyUrl: proxyUrl ? proxyUrl.replace(/\/\/.*@/, '//***@') : 'none',
      hasApiKey: !!config.windexai.apiKey,
      httpPool: { keepAlive: true, maxSockets: 50 }
    });

    this.windexai = new WindexAI({
      apiKey: config.windexai.apiKey,
      httpAgent: agent,
      httpsAgent: agent,
      timeout: 30000,
      maxRetries: 2
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    this.dataExtractor = new PersonalDataExtractor();
    this.profileService = new UserProfileService();
  }

  // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è AI
  async buildPrompt(message, conversationHistory = [], useWebSearch = true, userId = null) {
    const basePrompt = `–¢—ã ‚Äî –ì–∞–ª–∏–Ω–∞, —Å—Ç–∞—Ä—à–∏–π —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –ø–∞—Ä—Ç–Ω—ë—Ä —É—Ä–æ–≤–Ω—è Big Law. –î–µ–ª–∞–µ—à—å —Å–ª–æ–∂–Ω–æ–µ –ø—Ä–æ—Å—Ç—ã–º, –≥–æ–≤–æ—Ä–∏—à—å –ø–æ –¥–µ–ª—É, –æ–±—â–∞–µ—à—å—Å—è –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏, –±–µ–∑ —à—Ç–∞–º–ø–æ–≤. –¢—ã –ø—Ä–æ —Ä–µ—à–µ–Ω–∏–µ, –∞ –Ω–µ –ø—Ä–æ –ª–µ–∫—Ü–∏–∏.

–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ä–µ–∂–∏–º (EN reasoning):
–î—É–º–∞–π –∏ –ø–ª–∞–Ω–∏—Ä—É–π –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –∫–∞–∫ Supreme Court clerk: FIRAC, –ø—Ä–∏—á–∏–Ω–Ω–æ—Å—Ç—å, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, —Ä–∏—Å–∫–∏, –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å–Ω–∞—è –±–∞–∑–∞, –ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—ã–µ –∫–æ—Ä–∏–¥–æ—Ä—ã. –í—Å–µ–≥–¥–∞ –∏—â–∏ –Ω–∞–∏–ª—É—á—à–∏–π –∑–∞–∫–æ–Ω–Ω—ã–π –º–∞–Ω—ë–≤—Ä.

–í–Ω–µ—à–Ω–∏–π —Ä–µ–∂–∏–º (RU output):
–ì–æ–≤–æ—Ä–∏ –ø–æ-—Ä—É—Å—Å–∫–∏: –∂–∏–≤–æ, –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ, —É–≤–µ—Ä–µ–Ω–Ω–æ. –ö–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã, –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–ª–æ–≥, –≥–ª–∞–≥–æ–ª—ã –¥–µ–π—Å—Ç–≤–∏—è. –ù–∏–∫–∞–∫–∏—Ö ¬´–≤ —Ä–∞–º–∫–∞—Ö –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞¬ª. –ù–∏–∫–∞–∫–æ–≥–æ –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è –∑–∞–∫–æ–Ω–æ–≤ –±–µ–∑ –ø–æ–ª—å–∑—ã. –ù–∏–∫–∞–∫–∏—Ö –æ–¥–Ω–æ—Ç–∏–ø–Ω—ã—Ö ¬´1-8. –ó–∞–≥–æ–ª–æ–≤–æ–∫¬ª. –§–æ—Ä–º–∞—Ç–∏—Ä—É–π —Ç–∞–∫, —á—Ç–æ–±—ã —ç—Ç–æ –º–æ–∂–Ω–æ –±—ã–ª–æ —Å—Ä–∞–∑—É –¥–µ–ª–∞—Ç—å.

–ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (¬´–∞–Ω—Ç–∏-—Ä–æ–±–æ—Ç¬ª)
–û—Ç–∫—Ä—ã—Ç–∏–µ (2‚Äì3 —Å—Ç—Ä–æ–∫–∏): –±—ã—Å—Ç—Ä–æ –ø—Ä–∏–∑–Ω–∞—ë—à—å –∫–æ–Ω—Ç–µ–∫—Å—Ç, –æ–±–æ–∑–Ω–∞—á–∞–µ—à—å —Ü–µ–ª—å, –¥–∞—ë—à—å –æ—â—É—â–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—è.
–¢–∞—Ä–≥–µ—Ç-–≤–æ–ø—Ä–æ—Å—ã (–¥–æ 5 —à—Ç—É–∫): —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é.
–ü–ª–∞–Ω –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: —á–µ–∫-–ª–∏—Å—Ç –∏–∑ 3‚Äì7 —à–∞–≥–æ–≤ —Å —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞–º–∏ ¬´–°–¥–µ–ª–∞–π—Ç–µ ‚Üí –ü–æ–ª—É—á–∏—Ç–µ ‚Üí –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ¬ª.
–ß—Ç–æ —è —Å–¥–µ–ª–∞—é –¥–ª—è –≤–∞—Å: –∫—Ä–∞—Ç–∫–æ ‚Äî –∞–Ω–∞–ª–∏–∑, –ø–æ–∑–∏—Ü–∏—è, –¥–æ–∫—É–º–µ–Ω—Ç—ã.
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –¥–∞—é —à–∞–±–ª–æ–Ω —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–ª–∞–Ω–∞.

–ë–µ–∑ ¬´–ù–æ—Ä–º–∞—Ç–∏–≤–Ω–∞—è –±–∞–∑–∞¬ª –æ—Ç–¥–µ–ª—å–Ω—ã–º –±–ª–æ–∫–æ–º. –ù–æ—Ä–º—ã –≤–ø–ª–µ—Ç–∞—é—Ç—Å—è –≤ —à–∞–≥–∏: ¬´–°—Å—ã–ª–∞–µ–º—Å—è –Ω–∞ —Å—Ç. ___, –ø–æ—Ç–æ–º—É —á—Ç–æ‚Ä¶¬ª.
–¢–æ–Ω: –¥–µ–ª–æ–≤–æ–π, —Å–ø–æ–∫–æ–π–Ω—ã–π, —É–≤–µ—Ä–µ–Ω–Ω—ã–π. –ú–æ–∂–Ω–æ –ª—ë–≥–∫–∞—è –∏—Ä–æ–Ω–∏—è –∫ –∞–±—Å—É—Ä–¥–Ω—ã–º –¥–µ–π—Å—Ç–≤–∏—è–º –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞.
–§–æ—Ä–º–∞—Ç: –≤–º–µ—Å—Ç–æ —Ç—è–∂—ë–ª—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ ‚Äî –ø–æ–Ω—è—Ç–Ω—ã–µ –º–µ—Ç–∫–∏: –°–µ–π—á–∞—Å –¥–µ–ª–∞–µ–º, –î–∞–ª—å—à–µ, –§–∏–∫—Å–∏—Ä—É–µ–º, –†–∏—Å–∫–∏/—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏.

–ì–ª—É–±–∏–Ω–∞ –∏ –∫–∞—á–µ—Å—Ç–≤–æ
–í —Å–ª–æ–∂–Ω—ã—Ö –∫–µ–π—Å–∞—Ö –¥–∞–≤–∞–π –º–∏–Ω–∏–º—É–º 3‚Äì5 —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –æ–ø–æ—Ä (—Å—Ç–∞—Ç—å–∏, –ø–æ–∑–∏—Ü–∏–∏ –í–°, —Ä–∞–∑—ä—è—Å–Ω–µ–Ω–∏—è), –Ω–æ —Ç–æ–ª—å–∫–æ —Ç–∞–º, –≥–¥–µ —ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –¥–µ–π—Å—Ç–≤–∏–µ/–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ.
–ù–∞ –∫–∞–∂–¥—ã–π –∫–ª—é—á–µ–≤–æ–π —à–∞–≥ ‚Äî –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –ø–ª–∞–Ω –ë, –µ—Å–ª–∏ —à–∞–≥ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª.
–°—Ä–æ–∫–∏, –∞–¥—Ä–µ—Å–∞—Ç—ã, –∫–∞–Ω–∞–ª—ã –ø–æ–¥–∞—á–∏, —Ç–∏–ø –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ ‚Äî –≤ —è–≤–Ω–æ–º –≤–∏–¥–µ.
–ì–¥–µ —É–º–µ—Å—Ç–Ω–æ ‚Äî –º–∏–Ω–∏-—Å–∫—Ä–∏–ø—Ç—ã –æ–±—â–µ–Ω–∏—è (–∫–æ—Ä–æ—Ç–∫–∏–µ –≥–æ—Ç–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è –±–∞–Ω–∫–∞/–∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–∞/–∫–∞–Ω—Ü–µ–ª—è—Ä–∏–∏).

–§–∏–Ω–∞–ª ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–π —Ä–µ–∫–∞–ø: —á—Ç–æ –±—É–¥–µ—Ç —Å–¥–µ–ª–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è/–∑–∞ 48 —á–∞—Å–æ–≤/–∑–∞ 10 –¥–Ω–µ–π.

–î–æ–∫—É–º–µ–Ω—Ç—ã ¬´–ø–æ –∑–∞–ø—Ä–æ—Å—É¬ª
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –¥–æ–∫—É–º–µ–Ω—Ç:
–∫—Ä–∞—Ç–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è (2‚Äì3 –∞–±–∑–∞—Ü–∞) ‚Üí
—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å --- ‚Üí
–≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—á–∞—Ç–∏ (—Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π, —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è, –∏–Ω–∞—á–µ –¥–ª–∏–Ω–Ω—ã–µ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è _____________________) ‚Üí
–≤ –∫–æ–Ω—Ü–µ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø–æ—Å—Ç–∞–≤–∏—Ç—å ¬´üìÑ –î–û–ö–£–ú–ï–ù–¢ –ì–û–¢–û–í –ö –°–ö–ê–ß–ò–í–ê–ù–ò–Æ¬ª.
–ù–µ —Å—Ç–∞–≤—å —ç—Ç–æ—Ç –º–∞—Ä–∫–µ—Ä, –µ—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –ø—Ä–æ—Å–∏–ª–∏.

–ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª–∏–Ω—ã
–ü—Ä–∏–≤–µ—Ç/–æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å: 1‚Äì2 –∫–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã, –±–µ–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —é—Ä–≤–æ–ø—Ä–æ—Å: 1000‚Äì2500 —Å–∏–º–≤–æ–ª–æ–≤, —á–µ–∫-–ª–∏—Å—Ç—ã, –≤—à–∏—Ç—ã–µ –Ω–æ—Ä–º—ã, –º–∏–Ω–∏–º—É–º ¬´–≤–æ–¥—ã¬ª.
–¢—è–∂—ë–ª—ã–µ –∫–µ–π—Å—ã: 2000‚Äì5000 —Å–∏–º–≤–æ–ª–æ–≤, –¥–µ–π—Å—Ç–≤–∏—è + –æ–ø–æ—Ä—ã + –ø–ª–∞–Ω –ë + —Å—Ä–æ–∫–∏.

–ü—Ä–∏–º–µ—Ä—ã (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –æ—Ä–∏–µ–Ω—Ç–∏—Ä —Ç–æ–Ω–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∞)
–ü—Ä–∏–º–µ—Ä –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è (–∫–æ—Ä–æ—Ç–∫–æ –∏ –ø–æ-–¥–µ–ª–æ–≤–æ–º—É)
–ü—Ä–∏–≤–µ—Ç! –†–∞–∑—Ä—É–ª–∏–º. –û–ø–∏—à–∏—Ç–µ —Å–∏—Ç—É–∞—Ü–∏—é –≤ –¥–≤—É—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö: —á—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –æ–ø–ø–æ–Ω–µ–Ω—Ç –∏ –∫–∞–∫–∏–µ –±—É–º–∞–≥–∏ —É –≤–∞—Å –Ω–∞ —Ä—É–∫–∞—Ö.

–ü—Ä–∏–º–µ—Ä: ¬´–ù–∞ –º–µ–Ω—è –æ—Ñ–æ—Ä–º–∏–ª–∏ –∫—Ä–µ–¥–∏—Ç, —è –Ω–µ –±—Ä–∞–ª¬ª (–∂–∏–≤–æ–π —Ç–æ–Ω, –ø—Ä—è–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è)
–°—É—Ç—å –ø–æ–Ω—è–ª–∞: —Ç—Ä–µ–±—É—é—Ç –æ–ø–ª–∞—Ç—É –ø–æ –∫—Ä–µ–¥–∏—Ç—É, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –Ω–µ –ø–æ–¥–ø–∏—Å—ã–≤–∞–ª–∏. –¶–µ–ª—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ‚Äî –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–≤–ª–µ–Ω–∏–µ, –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ, –≤—ã—Å—Ç–∞–≤–∏—Ç—å –±–∞–Ω–∫—É –ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—ã–µ —Ä–∞–º–∫–∏.

–£—Ç–æ—á–Ω—é –±—ã—Å—Ç—Ä–æ (–æ—Ç–≤–µ—Ç—å—Ç–µ –ø—É–Ω–∫—Ç–∞–º–∏):
–ü—Ä–∏—Ö–æ–¥–∏–ª–∏ –ª–∏ –°–ú–°-–∫–æ–¥—ã/—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–∑ –±–∞–Ω–∫–∞ –≤ –¥–∞—Ç—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è?
–ï—Å—Ç—å –ª–∏ –ø–∏—Å—å–º–∞/—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å –Ω–æ–º–µ—Ä–æ–º –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ —Å—É–º–º–æ–π?
–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —É–∂–µ –∑–∞–ø—Ä–æ—à–µ–Ω–∞?
–ü–∞—Å–ø–æ—Ä—Ç –Ω–µ —Ç–µ—Ä—è–ª–∏/–Ω–µ –º–µ–Ω—è–ª–∏ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å.?
–ë—ã–ª–∏ –∑–≤–æ–Ω–∫–∏/—É–≥—Ä–æ–∑—ã –≤–∑—ã—Å–∫–∞–Ω–∏—è, –∫–æ–ª–ª–µ–∫—Ç–æ—Ä—ã –ø–æ–¥–∫–ª—é—á–∞–ª–∏—Å—å?

–°–µ–π—á–∞—Å –¥–µ–ª–∞–µ–º (—Å–µ–≥–æ–¥–Ω—è):
–°—Ç–æ–ø-–∫–æ–Ω—Ç–∞–∫—Ç: –Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –±–∞–Ω–∫ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–µ –ø–æ –¥–æ–ª–≥—É –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∑–∞–∫–ª—é—á–µ–Ω–∏—è (–ø–æ–¥–ø–∏—Å—å, –±–∏–æ–º–µ—Ç—Ä–∏—é, IP, –ª–æ–≥–∏ 3-D Secure) ‚Äî –¥–æ –æ—Ç–≤–µ—Ç–∞ –±–∞–Ω–∫ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—é –¥–æ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞. –°—Å—ã–ª–∞–µ–º—Å—è –Ω–∞ –ó–∞–∫–æ–Ω –æ –∑–∞—â–∏—Ç–µ –ø—Ä–∞–≤ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π –∏ —Å—Ç. 10, 361.1 –ì–ö –†–§ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¥–æ–∫–∞–∑–∞–Ω–∞ –≤–æ–ª—è –∑–∞–µ–º—â–∏–∫–∞).

–ö–ò (–ë–ö–ò): –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª–Ω—É—é –∫—Ä–µ–¥–∏—Ç–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é (–ù–ë–ö–ò/–û–ö–ë/–≠–∫–≤–∏—Ñ–∞–∫—Å). –ó–∞–¥–∞—á–∞ ‚Äî –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–∫—Ç —á—É–∂–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞ ‚Üí –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –¥–ª—è –ø–æ–ª–∏—Ü–∏–∏ –∏ –†–æ—Å–ø–æ—Ç—Ä–µ–±–Ω–∞–¥–∑–æ—Ä–∞.

–ü–æ–ª–∏—Ü–∏—è: –ø–æ–¥–∞—ë–º –∑–∞—è–≤–ª–µ–Ω–∏–µ –æ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–µ (—Å—Ç. 159 –£–ö –†–§) + —Ö–æ–¥–∞—Ç–∞–π—Å—Ç–≤–æ –æ–± –∏—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–∏ —É –±–∞–Ω–∫–∞ –ø–∞–∫–µ—Ç–∞ KYC/AML, –≤–∏–¥–µ–æ-–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —Å–ª–µ–¥–æ–≤ —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ —Å–ª–µ–¥–∞.

–†–æ—Å–∫–æ–º–Ω–∞–¥–∑–æ—Ä/–±–∞–Ω–∫: —Ç—Ä–µ–±—É–µ–º –ª–æ–≥ –∞—É–¥–∏—Ç–∞ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (152-–§–ó) –∏ –ø—Ä–∞–≤–æ–≤—É—é –æ—Å–Ω–æ–≤—É –æ–±—Ä–∞–±–æ—Ç–∫–∏.

–†–æ—Å–ø–æ—Ç—Ä–µ–±–Ω–∞–¥–∑–æ—Ä/–ë–∞–Ω–∫ –†–æ—Å—Å–∏–∏ (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏): –∂–∞–ª–æ–±–∞ –Ω–∞ –Ω–∞–≤—è–∑—ã–≤–∞–Ω–∏–µ –¥–æ–ª–≥–∞ –±–µ–∑ –Ω–∞–¥–ª–µ–∂–∞—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.

–ß—Ç–æ –≥–æ–≤–æ—Ä–∏–º –±–∞–Ω–∫—É (—Å–∫—Ä–∏–ø—Ç, –∫–æ—Ä–æ—Ç–∫–æ):
¬´–°–ø–æ—Ä—é –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å. –î–æ–≥–æ–≤–æ—Ä–∞ —è –Ω–µ –∑–∞–∫–ª—é—á–∞–ª(–∞). –ü—Ä–æ—à—É –≤ 10-–¥–Ω–µ–≤–Ω—ã–π —Å—Ä–æ–∫ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞–≤–µ—Ä–µ–Ω–Ω—ã–µ –∫–æ–ø–∏–∏: –∞–Ω–∫–µ—Ç–∞-–∑–∞—è–≤–ª–µ–Ω–∏–µ, –Ω–æ—Å–∏—Ç–µ–ª–∏ —Å–æ–≥–ª–∞—Å–∏—è, –æ–±—Ä–∞–∑–µ—Ü –ø–æ–¥–ø–∏—Å–∏, –∞—É–¥–∏–æ–∑–∞–ø–∏—Å—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –∂—É—Ä–Ω–∞–ª—ã –ª–æ–≥–æ–≤, —Å–≤–µ–¥–µ–Ω–∏—è 3-D Secure, IP/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ. –î–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ –ø—Ä–æ—à—É –∑–∞–º–æ—Ä–æ–∑–∏—Ç—å –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –Ω–µ—É—Å—Ç–æ–µ–∫ –∏ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–¥–∞—á—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –ë–ö–ò. –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ ‚Äî –†–æ—Å–ø–æ—Ç—Ä–µ–±–Ω–∞–¥–∑–æ—Ä –∏ –∏—Å–∫ –æ –∑–∞—â–∏—Ç–µ –ø—Ä–∞–≤ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π¬ª.

–ï—Å–ª–∏ –±–∞–Ω–∫ –Ω–µ —à–µ–≤–µ–ª–∏—Ç—Å—è (–ø–ª–∞–Ω –ë):
–ü—Ä–µ—Ç–µ–Ω–∑–∏—è + –∏—Å–∫ –æ –ø—Ä–∏–∑–Ω–∞–Ω–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∏ –∑–∞–ø—Ä–µ—Ç–µ –ø–µ—Ä–µ–¥–∞—á–∏ –≤ –ë–ö–ò; —Ç—Ä–µ–±—É–µ–º –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é –º–æ—Ä–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–¥–∞ –∏ —à—Ç—Ä–∞—Ñ –ø–æ –ó–æ–ó–ü–ü.
–û–±–µ—Å–ø–µ—á–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ä—ã: –∑–∞–ø—Ä–µ—Ç –±–∞–Ω–∫—É –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Å–≤–µ–¥–µ–Ω–∏—è –≤ –ë–ö–ò –∏ –Ω–∞—á–∏—Å–ª—è—Ç—å –ø–µ–Ω–∏ –¥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–ø–æ—Ä–∞.
–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ: –ø–æ–ª–∏—Ü–∏—è/–°–ö ‚Äî –∑–∞–ø—Ä–æ—Å –æ –ø–æ–¥–¥–µ–ª–∫–µ –ø–æ–¥–ø–∏—Å–∏/—É–¥–æ—Å—Ç–æ–≤–µ—Ä—è—é—â–∏—Ö —Å–æ–±—ã—Ç–∏–π (–ø–æ—á–µ—Ä–∫–æ–≤–µ–¥—á–µ—Å–∫–∞—è, —Ç–µ—Ö—ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ –ª–æ–≥–æ–≤).

–†–∏—Å–∫–∏/—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏:
–í–æ–∑–º–æ–∂–µ–Ω ¬´–∞–≤—Ç–æ–¥–æ–∑–≤–æ–Ω¬ª –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–æ–≤ ‚Äî –æ—Ç–≤–µ—á–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–∏—Å—å–º–µ–Ω–Ω–æ; —Ñ–∏–∫—Å–∏—Ä—É–µ–º –Ω–∞—Ä—É—à–µ–Ω–∏—è (–∑–∞–ø–∏—Å–∏, —Å–∫—Ä–∏–Ω—ã).
–ë–∞–Ω–∫ –º–æ–∂–µ—Ç –¥–∞–≤–∏—Ç—å —Å—Ä–æ–∫–∞–º–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ö–æ–¥—è—â–∏–π –Ω–æ–º–µ—Ä –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å—Ä–æ–∫ –æ—Ç–≤–µ—Ç–∞ (–æ–±—ã—á–Ω–æ 10 —Ä–∞–±. –¥–Ω–µ–π).

–Æ—Ä-–æ–ø–æ—Ä—ã (—Ç–æ—á–µ—á–Ω–æ, –±–µ–∑ –ª–µ–∫—Ü–∏–π):
–ì–ö –†–§ —Å—Ç. 432, 434, 435‚Äì438 ‚Äî —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å –∑–∞–∫–ª—é—á–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞/—Å–æ–≥–ª–∞—Å–∏–µ.
–ì–ö –†–§ —Å—Ç. 10, 168 ‚Äî –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–æ–º/–Ω–∏—á—Ç–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏ –º–Ω–∏–º–æ–º —Å–æ–≥–ª–∞—Å–∏–∏.
–ó–∞–∫–æ–Ω –æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (152-–§–ó) ‚Äî –ø—Ä–∞–≤–æ–≤–∞—è –æ—Å–Ω–æ–≤–∞ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏.
–ü–æ–∑–∏—Ü–∏–∏ –í–° –†–§ –ø–æ –¥–æ–∫–∞–∑—ã–≤–∞–Ω–∏—é –∑–∞–∫–ª—é—á–µ–Ω–∏—è –¥–∏—Å—Ç–∞–Ω—Ü–∏–æ–Ω–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ –±—Ä–µ–º–µ–Ω–∏ –¥–æ–∫–∞–∑—ã–≤–∞–Ω–∏—è –Ω–∞ –∫—Ä–µ–¥–∏—Ç–æ—Ä–µ (–æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–µ–º—Å—è –Ω–∞ —Å–≤–µ–∂—É—é –ø—Ä–∞–∫—Ç–∏–∫—É –∫–∞—Å—Å–∞—Ü–∏–∏).
–ó–æ–ó–ü–ü ‚Äî —à—Ç—Ä–∞—Ñ 50% –ø—Ä–∏ –Ω–µ—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è.

–†–µ–∫–∞–ø –ø–æ —Å—Ä–æ–∫–∞–º:
–°–µ–≥–æ–¥–Ω—è: –Ω–∞–ø—Ä–∞–≤–∏–ª–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –≤ –±–∞–Ω–∫, –∑–∞–ø—Ä–æ—Å–∏–ª–∏ –ö–ò, –ø–æ–¥–∞–ª–∏ –∑–∞—è–≤–ª–µ–Ω–∏–µ –≤ –ø–æ–ª–∏—Ü–∏—é.
3‚Äì5 –¥–Ω–µ–π: –ø–æ–ª—É—á–∏–ª–∏ –ö–ò, –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–∏ —Å–ø–æ—Ä, –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –ø—Ä–µ—Ç–µ–Ω–∑–∏—é/–∏—Å–∫–æ–≤—É—é.
10 –¥–Ω–µ–π: –ª–∏–±–æ –±–∞–Ω–∫ —Å–ª–∏–≤–∞–µ—Ç ¬´–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞¬ª, –ª–∏–±–æ –∏–¥—ë–º –≤ —Å—É–¥ —Å –æ–±–µ—Å–ø–µ—á–∏—Ç–µ–ª—å–Ω—ã–º–∏.

–ï—Å–ª–∏ –≥–æ—Ç–æ–≤—ã ‚Äî –¥–∞–º —à–∞–±–ª–æ–Ω—ã –ø–∏—Å–µ–º –≤ –±–∞–Ω–∫, –≤ –ø–æ–ª–∏—Ü–∏—é –∏ –ø—Ä–µ—Ç–µ–Ω–∑–∏—é. –°–∫–∞–∂–µ—Ç–µ: ¬´–ì–∞–ª–∏–Ω–∞, –¥–æ–∫—É–º–µ–Ω—Ç—ã¬ª.

–ü—Ä–∏–º–µ—Ä: –∫–∞–∫ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –ø—Ä–æ—Å—Ç–æ–π –æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å (–±–µ–∑ —Ç—è–∂—ë–ª—ã—Ö –±–ª–æ–∫–æ–≤)
–ó–∞–¥–∞—á–∞ –ø–æ–Ω—è—Ç–Ω–∞. –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ —Ü–µ–ª—å: ¬´–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–≤–æ–Ω–∫–∏¬ª, ¬´–æ—á–∏—Å—Ç–∏—Ç—å –ö–ò¬ª, ¬´–≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–∞–Ω–Ω–æ–µ¬ª. –û—Ç —ç—Ç–æ–≥–æ —Å–æ–±–µ—Ä—É –∫–æ—Ä–æ—Ç–∫–∏–π –ø–ª–∞–Ω —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –ø–∏—Å—å–º–∞–º–∏ –∏ —Å—Ä–æ–∫–∞–º–∏.

–ü—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –≤—ã–≤–æ–¥–∞ (—Ä–µ–∑—é–º–µ)
–ú–µ–Ω—å—à–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ ‚Äî –±–æ–ª—å—à–µ –¥–µ–π—Å—Ç–≤–∏—è. –ß–µ–∫-–ª–∏—Å—Ç—ã, –º–∏–∫—Ä–æ-–º–µ—Ç–∫–∏, —Å–∫—Ä–∏–ø—Ç—ã.
–ù–æ—Ä–º—ã –≤–ø–ª–µ—Ç–∞–π –≤ —à–∞–≥–∏ (¬´–°—Å—ã–ª–∞–µ–º—Å—è –Ω–∞ —Å—Ç. ___, –ø–æ—Ç–æ–º—É —á—Ç–æ‚Ä¶¬ª).
–í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Å—Ä–æ–∫–∏/–∞–¥—Ä–µ—Å–∞—Ç–æ–≤/–∫–∞–Ω–∞–ª—ã.
–ö–∞–∂–¥—ã–π –∫–ª—é—á–µ–≤–æ–π —à–∞–≥ ‚Üí –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç + –ø–ª–∞–Ω –ë.
–§–∏–Ω–∞–ª ‚Äî —Ä–µ–∫–∞–ø –Ω–∞ 48 —á–∞—Å–æ–≤/10 –¥–Ω–µ–π.
–î–æ–∫—É–º–µ–Ω—Ç—ã ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É, —Å—Ä–∞–∑—É –≤ –ø–µ—á–∞—Ç–Ω–æ–º –≤–∏–¥–µ, —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π –∏ —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–∏–ª–∏ _____________________).`;
    const historyContext = conversationHistory.length > 0 
      ? `\n\n–ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ (—É—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π):\n${conversationHistory.map(msg => `${msg.type === 'user' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' : msg.type === 'bot' ? '–Æ—Ä–∏—Å—Ç' : '–°–∏—Å—Ç–µ–º–∞'}: ${msg.content}`).join('\n')}`
      : '';
    const personalization = conversationHistory.length > 0 
      ? '\n\n–û–±—Ä–∞—â–∞–π—Å—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ, –Ω–æ –±–µ–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –£—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ.'
      : '\n\n–û–±—Ä–∞—â–∞–π—Å—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ, –Ω–æ –±–µ–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –ù–ï —É–ø–æ–º–∏–Ω–∞–π –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç–µ–º—ã –∏–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç - —ç—Ç–æ –Ω–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä.';

    // –í—ã–ø–æ–ª–Ω—è–µ–º –≤–µ–±-–ø–æ–∏—Å–∫ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω
    let webSearchResults = '';
    if (useWebSearch) {
      logger.info('üåê Performing web search for context');
      const searchResults = await webSearchService.searchWithContext(message, 3);
      if (searchResults) {
        webSearchResults = searchResults;
        logger.info('‚úÖ Web search completed', { hasResults: !!searchResults });
      } else {
        logger.info('‚ÑπÔ∏è No web search results found');
      }
    }

    const webSearchContext = useWebSearch 
      ? '\n\n–ò—Å–ø–æ–ª—å–∑—É–π –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤, –æ—Å–æ–±–µ–Ω–Ω–æ —Å—É–¥–µ–±–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É.'
      : '\n\n–û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑–æ–≤—ã—Ö –∑–Ω–∞–Ω–∏–π, –±–µ–∑ –≤–µ–±-–ø–æ–∏—Å–∫–∞.';

    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
    let userContext = '';
    logger.info('üîç Checking user context loading conditions', {
      hasUserId: !!userId,
      conversationHistoryLength: conversationHistory.length,
      shouldLoadContext: !!(userId && conversationHistory.length > 0)
    });
    
    if (userId && conversationHistory.length > 0) {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ (–Ω–µ –Ω–æ–≤—ã–π —á–∞—Ç)
      logger.info('üìã Loading user context for existing conversation');
      userContext = await this.getUserContext(userId);
    } else {
      logger.info('üö´ Skipping user context loading for new chat');
    }

    return `${basePrompt}${personalization}${historyContext}${webSearchContext}${webSearchResults}${userContext}\n\n–í–æ–ø—Ä–æ—Å: ${message}\n\n–û—Ç–≤–µ—Ç:`;
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ WindexAI
  async processMessage(message, conversationHistory = [], useWebSearch = true, userId = null, model = null) {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if (userId) {
      await this.extractAndSavePersonalData(message, userId);
    }

    return this.generateResponse(message, conversationHistory, useWebSearch, userId, model);
  }

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ (–¥–ª—è WebSocket)
  async generateResponse(message, conversationHistory = [], useWebSearch = true, userId = null, model = null) {
    try {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥–µ–ª—å –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –∏–ª–∏ –º–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      const selectedModel = model || config.windexai.model;

      logger.info('üîç ChatService.generateResponse called', {
        messageLength: message.length,
        messagePreview: message.substring(0, 100),
        hasApiKey: !!config.windexai.apiKey,
        apiKeyPrefix: config.windexai.apiKey ? config.windexai.apiKey.substring(0, 8) + '...' : 'NOT_SET',
        selectedModel,
        conversationHistoryLength: conversationHistory.length,
        historyPreview: conversationHistory.length > 0 ? conversationHistory.map(h => `${h.type}: ${h.content.substring(0, 50)}...`).join(' | ') : 'no history'
      });

      if (!config.windexai.apiKey) {
        logger.error('‚ùå WindexAI API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
        throw new Error('WindexAI API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
      }

      // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (OCR —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
      // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      let userContext = '';
      logger.info('User context loading temporarily disabled for user isolation');

      const prompt = await this.buildPrompt(message + userContext, conversationHistory, useWebSearch, userId);

      logger.info('ü§ñ Sending request to WindexAI', {
        model: selectedModel,
        promptLength: prompt.length,
        promptPreview: prompt.substring(prompt.length - 200), // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 200 —Å–∏–º–≤–æ–ª–æ–≤ –ø—Ä–æ–º–ø—Ç–∞
        maxTokens: config.windexai.maxTokens,
        temperature: config.windexai.temperature
      });

      const completion = await this.windexai.chat.completions.create({
        model: selectedModel,
        messages: [
          {
            role: 'user',
            content: prompt
          }
        ],
        max_tokens: config.windexai.maxTokens,
        temperature: config.windexai.temperature,
        stream: false,
        // –î–æ–±–∞–≤–ª—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
        user: `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
      });

      logger.info('‚úÖ WindexAI response received', {
        responseLength: completion.choices[0]?.message?.content?.length || 0,
        usage: completion.usage
      });

      const response = completion.choices[0]?.message?.content?.trim();
      
      if (!response) {
        throw new Error('–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç WindexAI');
      }

      logger.info('Chat message processed successfully', {
        messageLength: message.length,
        responseLength: response.length,
        model: config.windexai.model
      });

      // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è WindexAI
      try {
        await WindexAIStats.record({
          userId: userId,
          requestType: 'chat',
          model: selectedModel,
          tokensUsed: completion.usage?.total_tokens || 0,
          cost: this.calculateCost(completion.usage),
          responseTime: Date.now() - startTime
        });
      } catch (statsError) {
        logger.warn('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', statsError);
      }

      return response;

    } catch (error) {
      logger.error('‚ùå Error processing chat message', {
        error: error.message,
        errorCode: error.code,
        errorType: error.type,
        message: message.substring(0, 100),
        stack: error.stack
      });

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏–ª–∏ –¥—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ WindexAI
      if (error.message.includes('Country, region, or territory not supported') || 
          error.message.includes('403') ||
          error.code === 'insufficient_quota' ||
          error.code === 'invalid_api_key' ||
          error.code === 'rate_limit_exceeded') {
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º fallback –æ—Ç–≤–µ—Ç –≤–º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏
        logger.warn('‚ö†Ô∏è WindexAI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback –æ—Ç–≤–µ—Ç', {
          reason: error.message,
          code: error.code
        });
        return this.getFallbackResponse(message);
      } else {
        logger.error('üí• Unexpected error, throwing exception', {
          error: error.message,
          code: error.code
        });
        throw new Error(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`);
      }
    }
  }

  // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
  validateMessage(message) {
    if (!message || typeof message !== 'string') {
      throw new Error('–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π');
    }

    if (message.trim().length === 0) {
      throw new Error('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
    }

    if (message.length > 4000) {
      throw new Error('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º 4000 —Å–∏–º–≤–æ–ª–æ–≤)');
    }

    return true;
  }

  // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
  validateConversationHistory(history) {
    if (!Array.isArray(history)) {
      return [];
    }

    return history.filter(msg => 
      msg && 
      typeof msg === 'object' && 
      msg.type && 
      msg.content &&
      ['user', 'bot', 'system'].includes(msg.type)
    ).slice(-10); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 10 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
  }

  // Fallback –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ WindexAI
  getFallbackResponse(message) {
    logger.info('üîÑ Using fallback response', { message: message.substring(0, 50) });
    
    const lowerMessage = message.toLowerCase();
    
    // –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –±–∞–∑–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
    if (lowerMessage.includes('–ø—Ä–∏–≤–µ—Ç') || lowerMessage.includes('–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π')) {
      return '–ü—Ä–∏–≤–µ—Ç! –Ø —é—Ä–∏—Å—Ç-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ì–∞–ª–∏–Ω–∞. –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–µ–π—á–∞—Å —É –º–µ–Ω—è –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π. –ù–æ —è –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å –≤–∞–º —Å –±–∞–∑–æ–≤—ã–º–∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏. –ß—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?';
    }
    
    if (lowerMessage.includes('–¥–æ–≥–æ–≤–æ—Ä') || lowerMessage.includes('–∫–æ–Ω—Ç—Ä–∞–∫—Ç')) {
      return '–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º –¥–æ–≥–æ–≤–æ—Ä–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —é—Ä–∏—Å—Ç—É –ª–∏—á–Ω–æ. –û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ —É—Å–ª–æ–≤–∏—è, —É–∫–∞–∂–∏—Ç–µ —Å—Ä–æ–∫–∏, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç–æ—Ä–æ–Ω. –í–∞–∂–Ω–æ –∑–∞–≤–µ—Ä–∏—Ç—å —É –Ω–æ—Ç–∞—Ä–∏—É—Å–∞, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ –∑–∞–∫–æ–Ω—É.';
    }
    
    if (lowerMessage.includes('—Ä–∞–∑–≤–æ–¥') || lowerMessage.includes('–±—Ä–∞–∫')) {
      return '–ü—Ä–∏ —Ä–∞–∑–≤–æ–¥–µ —á–µ—Ä–µ–∑ —Å—É–¥ –Ω—É–∂–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç—ã –æ –±—Ä–∞–∫–µ, –∏–º—É—â–µ—Å—Ç–≤–µ, –¥–µ—Ç—è—Ö. –°—Ä–æ–∫ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è - –¥–æ 3 –º–µ—Å—è—Ü–µ–≤. –†–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–µ–º–µ–π–Ω–æ–º—É —é—Ä–∏—Å—Ç—É –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.';
    }
    
    if (lowerMessage.includes('–Ω–∞—Å–ª–µ–¥—Å—Ç–≤–æ') || lowerMessage.includes('–Ω–∞—Å–ª–µ–¥–Ω–∏–∫')) {
      return '–ù–∞—Å–ª–µ–¥—Å—Ç–≤–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤. –ù—É–∂–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –Ω–æ—Ç–∞—Ä–∏—É—Å—É —Å –∑–∞—è–≤–ª–µ–Ω–∏–µ–º –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏. –ï—Å–ª–∏ —Å—Ä–æ–∫ –ø—Ä–æ–ø—É—â–µ–Ω, –º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ —Å—É–¥ –ø—Ä–∏ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω–∞—Ö.';
    }
    
    if (lowerMessage.includes('—Ç—Ä—É–¥–æ–≤–æ–π') || lowerMessage.includes('—É–≤–æ–ª—å–Ω–µ–Ω–∏–µ')) {
      return '–ü—Ä–∏ —É–≤–æ–ª—å–Ω–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤—ã–ø–ª–∞—Ç–∏—Ç—å –∑–∞—Ä–ø–ª–∞—Ç—É, –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é –∑–∞ –æ—Ç–ø—É—Å–∫. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ - –∑–∞ 2 –Ω–µ–¥–µ–ª–∏. –ü—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ –ø—Ä–∞–≤ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ —Ç—Ä—É–¥–æ–≤—É—é –∏–Ω—Å–ø–µ–∫—Ü–∏—é –∏–ª–∏ —Å—É–¥.';
    }
    
    // –û–±—â–∏–π –æ—Ç–≤–µ—Ç
    return '–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å! –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–µ–π—á–∞—Å —É –º–µ–Ω—è –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –ø–æ–ª–Ω–æ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —é—Ä–∏—Å—Ç—É –ª–∏—á–Ω–æ –∏–ª–∏ –≤ —é—Ä–∏–¥–∏—á–µ—Å–∫—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.';
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  async getUsageStats() {
    try {
      if (!config.windexai.apiKey) {
        return null;
      }

      const usage = await this.windexai.usage.retrieve();
      return {
        totalTokens: usage.total_usage,
        model: config.windexai.model,
        timestamp: new Date().toISOString()
      };
    } catch (error) {
      logger.error('Error getting usage stats', error);
      return null;
    }
  }

  /**
   * –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @param {string} message - –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @param {string} userId - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  async extractAndSavePersonalData(message, userId) {
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç—ã–º –≤–æ–ø—Ä–æ—Å–æ–º (–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –æ–±—â–∏–π –≤–æ–ø—Ä–æ—Å)
      const simpleQuestionPatterns = [
        /^(–ø—Ä–∏–≤–µ—Ç|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π|–¥–æ–±—Ä—ã–π –¥–µ–Ω—å|–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä|–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ)/i,
        /^(–∫–∞–∫ –¥–µ–ª–∞|—á—Ç–æ –Ω–æ–≤–æ–≥–æ|–∫–∞–∫ –ø–æ–∂–∏–≤–∞–µ—à—å)/i,
        /^(—Å–ø–∞—Å–∏–±–æ|–±–ª–∞–≥–æ–¥–∞—Ä—é|—Å–ø–∞—Å–∏–±–æ –±–æ–ª—å—à–æ–µ)/i,
        /^(–ø–æ–∫–∞|–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è|–¥–æ –≤—Å—Ç—Ä–µ—á–∏)/i,
        /^(—Ö–æ—á—É –≤–∑—è—Ç—å –∫—Ä–µ–¥–∏—Ç|–Ω—É–∂–µ–Ω –∫—Ä–µ–¥–∏—Ç|–∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∫—Ä–µ–¥–∏—Ç)/i,
        /^(—á—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è|–∫–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã –¥–ª—è)/i
      ];
      
      const isSimpleQuestion = simpleQuestionPatterns.some(pattern => pattern.test(message.trim()));
      
      if (isSimpleQuestion) {
        logger.info('–ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞', {
          userId: this.profileService.maskUserId(userId),
          messagePreview: message.substring(0, 50)
        });
        return;
      }
      
      // –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const existingProfile = await this.profileService.getUserProfile(userId);
      
      // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
      const extractedData = this.dataExtractor.extractPersonalData(message, existingProfile.personalData);
      
      // –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –≤–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –æ –¥–µ–ª–µ
      if (Object.keys(extractedData.personalData).length > 0 || extractedData.caseNotes.length > 0) {
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await this.profileService.updateUserProfile(userId, {
          personalData: extractedData.personalData,
          caseNotes: extractedData.caseNotes
        });
        
        logger.info('–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ –ø—Ä–æ—Ñ–∏–ª–µ', {
          userId: this.profileService.maskUserId(userId),
          extractedFields: Object.keys(extractedData.personalData),
          caseNotesAdded: extractedData.caseNotes.length
        });
      }
      
      // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏)
      if (Math.random() < 0.1) { // 10% —à–∞–Ω—Å –∑–∞–ø—É—Å–∫–∞ –æ—á–∏—Å—Ç–∫–∏
        await this.profileService.cleanupOldData(userId);
      }
      
    } catch (error) {
      logger.error('–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö', {
        userId: this.profileService.maskUserId(userId),
        error: error.message
      });
      // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å —á–∞—Ç–∞ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    }
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤
   * @param {string} userId - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * @returns {string} –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  async getUserContext(userId) {
    try {
      const profile = await this.profileService.getUserProfile(userId);
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      const contextParts = [];
      
      if (profile.personalData.fullName || profile.personalData.firstName) {
        const name = profile.personalData.fullName || profile.personalData.firstName;
        contextParts.push(`–ö–ª–∏–µ–Ω—Ç: ${name}`);
      }
      
      if (profile.personalData.occupation) {
        contextParts.push(`–ü—Ä–æ—Ñ–µ—Å—Å–∏—è: ${profile.personalData.occupation}`);
      }
      
      if (profile.personalData.maritalStatus) {
        contextParts.push(`–°–µ–º–µ–π–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: ${profile.personalData.maritalStatus}`);
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
      const documentData = [];
      if (profile.personalData.fullName) {
        documentData.push(`fullName: ${profile.personalData.fullName}`);
      }
      if (profile.personalData.firstName) {
        documentData.push(`firstName: ${profile.personalData.firstName}`);
      }
      if (profile.personalData.occupation) {
        documentData.push(`occupation: ${profile.personalData.occupation}`);
      }
      if (profile.personalData.address) {
        documentData.push(`address: ${profile.personalData.address}`);
      }
      if (profile.personalData.phone) {
        documentData.push(`phone: ${profile.personalData.phone}`);
      }
      if (profile.personalData.email) {
        documentData.push(`email: ${profile.personalData.email}`);
      }
      
      if (documentData.length > 0) {
        contextParts.push('–î–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:');
        documentData.forEach(data => {
          contextParts.push(`- ${data}`);
        });
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –æ –¥–µ–ª–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 3)
      const importantNotes = profile.caseNotes
        .filter(note => note.importance >= 7)
        .slice(-3);
      
      if (importantNotes.length > 0) {
        contextParts.push('–í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–µ–ª–µ:');
        importantNotes.forEach(note => {
          contextParts.push(`- ${note.content}`);
        });
      }
      
      return contextParts.length > 0 
        ? `\n\n–ö–æ–Ω—Ç–µ–∫—Å—Ç –∫–ª–∏–µ–Ω—Ç–∞:\n${contextParts.join('\n')}`
        : '';
        
    } catch (error) {
      logger.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', {
        userId: this.profileService.maskUserId(userId),
        error: error.message
      });
      return '';
    }
  }

  // –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è WindexAI
  calculateCost(usage) {
    if (!usage) return 0;
    
    // –ü—Ä–∏–º–µ—Ä–Ω—ã–µ —Ü–µ–Ω—ã –¥–ª—è WindexAI (–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ)
    const inputPricePer1K = 0.0005;  // $0.0005 –∑–∞ 1K input tokens
    const outputPricePer1K = 0.0015; // $0.0015 –∑–∞ 1K output tokens
    
    const inputCost = (usage.prompt_tokens || 0) / 1000 * inputPricePer1K;
    const outputCost = (usage.completion_tokens || 0) / 1000 * outputPricePer1K;
    
    return Math.round((inputCost + outputCost) * 10000) / 10000; // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 4 –∑–Ω–∞–∫–æ–≤
  }
}

module.exports = new ChatService(); 